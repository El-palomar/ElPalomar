<!-- formulario-actividades.component.html -->

<!-- Botón para abrir el formulario -->
<section class="p-3">
<div class="mb-4">
  <button 
    type="button" 
    class="btn btn-success btn-lg"
    (click)="abrirNuevaActividad()">
    <i class="fas fa-plus"></i> Nueva Actividad
  </button>
</div>

<!-- Modal Formulario de Actividad -->
<div class="modal fade" [id]="modalId" tabindex="-1" [attr.aria-labelledby]="modalId + 'Label'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" [id]="modalId + 'Label'">
          {{ editando ? 'Editar Actividad' : 'Nueva Actividad' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <!-- ✅ Envolver en form con formGroup -->
        <form [formGroup]="activityForm" (ngSubmit)="onSubmit()">
          <!-- Nombre -->
          <div class="mb-3">
            <label [for]="modalId + 'nombre'" class="form-label">Nombre de la actividad *</label>
            <input 
              type="text" 
              [id]="modalId + 'nombre'"
              class="form-control"
              formControlName="nombre"
              placeholder="Ej: Básquet"
              [class.is-invalid]="isFieldInvalid('nombre')">
            
            <div class="invalid-feedback" *ngIf="isFieldInvalid('nombre')">
              El nombre es obligatorio (mínimo 3 caracteres)
            </div>
          </div>

          <!-- Categoría -->
          <div class="mb-3">
            <label [for]="modalId + 'categoria'" class="form-label">Categoría *</label>
            <select 
              [id]="modalId + 'categoria'" 
              class="form-select"
              formControlName="categoria"
              [class.is-invalid]="isFieldInvalid('categoria')">
              <option value="">Seleccione una categoría</option>
              <option *ngFor="let cat of categorias" [value]="cat.value">
                {{ cat.label }}
              </option>
            </select>
            
            <div class="invalid-feedback" *ngIf="isFieldInvalid('categoria')">
              Debe seleccionar una categoría
            </div>
          </div>

          <!-- Descripción -->
          <div class="mb-3">
            <label [for]="modalId + 'descripcion'" class="form-label">Descripción</label>
            <textarea 
              [id]="modalId + 'descripcion'"
              class="form-control"
              formControlName="descripcion"
              rows="3"
              placeholder="Descripción de la actividad">
            </textarea>
          </div>

          <!-- Horario -->
          <div class="mb-3">
            <label [for]="modalId + 'horario'" class="form-label">Horario *</label>
            <input 
              type="text" 
              [id]="modalId + 'horario'"
              class="form-control"
              formControlName="horario"
              placeholder="Ej: 18:00 - 20:00"
              [class.is-invalid]="isFieldInvalid('horario')">
            
            <div class="invalid-feedback" *ngIf="isFieldInvalid('horario')">
              El horario es obligatorio
            </div>
          </div>

          <!-- Instructor -->
          <div class="mb-3">
            <label [for]="modalId + 'instructor'" class="form-label">Instructor *</label>
            <input 
              type="text" 
              [id]="modalId + 'instructor'"
              class="form-control"
              formControlName="instructor"
              placeholder="Nombre del instructor"
              [class.is-invalid]="isFieldInvalid('instructor')">
            
            <div class="invalid-feedback" *ngIf="isFieldInvalid('instructor')">
              El instructor es obligatorio
            </div>
          </div>

          <!-- Cupo Máximo -->
          <div class="mb-3">
            <label [for]="modalId + 'cupoMaximo'" class="form-label">Cupo máximo *</label>
            <input 
              type="number" 
              [id]="modalId + 'cupoMaximo'"
              class="form-control"
              formControlName="cupoMaximo"
              min="1"
              max="100"
              placeholder="Ej: 20"
              [class.is-invalid]="isFieldInvalid('cupoMaximo')">
            
            <div class="invalid-feedback" *ngIf="isFieldInvalid('cupoMaximo')">
              Debe ingresar un cupo válido (1-100)
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          [disabled]="activityForm.invalid"
          (click)="onSubmit()">
          <i class="fas fa-save"></i>
          {{ editando ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Actividades -->
<div class="row">
  <div class="col-lg-4 col-md-6 mb-4" *ngFor="let activity of actividades; trackBy: trackByActivityId">
    <div class="card h-100 activity-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">{{ activity.nombre }}</h5>
          <span [class]="'badge ' + getCategoryClass(activity.categoria)">
            {{ getCategoryLabel(activity.categoria) }}
          </span>
        </div>
        <div class="dropdown" *ngIf="mostrarAcciones">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                  type="button"
                  [id]="'dropdown' + activity.id"
                  data-bs-toggle="dropdown" 
                  aria-expanded="false">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <ul class="dropdown-menu" [attr.aria-labelledby]="'dropdown' + activity.id">
            <li>
              <button class="dropdown-item" type="button" (click)="editarActividad(activity)">
                <i class="fas fa-edit text-primary"></i> Editar
              </button>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <button class="dropdown-item text-danger" type="button" (click)="eliminarActividad(activity)">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div class="card-body">
        <p class="card-text text-muted small">{{ activity.descripcion }}</p>
        
        <div class="activity-info mb-3">
          <div class="info-item mb-1">
            <i class="fas fa-clock text-primary me-2"></i>
            <span>{{ activity.horario }}</span>
          </div>
          <div class="info-item mb-1">
            <i class="fas fa-user text-primary me-2"></i>
            <span>{{ activity.instructor }}</span>
          </div>
          <div class="info-item mb-1">
            <i class="fas fa-users text-primary me-2"></i>
            <span [class]="getCapacityClass(activity)">
              {{ activity.inscritos }}/{{ activity.cupoMaximo }} inscriptos
            </span>
          </div>
        </div>

        <!-- Barra de Progreso -->
        <div class="progress mb-3" style="height: 8px;">
          <div class="progress-bar" 
               [class]="getProgressBarClass(activity)"
               role="progressbar"
               [style.width.%]="getProgressPercentage(activity)"
               [attr.aria-valuenow]="activity.inscritos"
               [attr.aria-valuemin]="0"
               [attr.aria-valuemax]="activity.cupoMaximo">
          </div>
        </div>

        <!-- Lista de Participantes -->
        <div *ngIf="activity.participantes && activity.participantes.length > 0 && mostrarParticipantes" class="mb-3">
          <h6 class="small fw-bold text-muted mb-2">
            <i class="fas fa-list"></i> Participantes ({{ activity.participantes.length }})
          </h6>
          <div class="participant-list" style="max-height: 120px; overflow-y: auto;">
            <div class="participant-item d-flex justify-content-between align-items-center mb-1" 
                 *ngFor="let participant of activity.participantes; trackBy: trackByParticipant">
              <span class="participant-name small">{{ participant }}</span>
              <button 
                *ngIf="permitirBajas"
                class="btn btn-sm btn-outline-danger participant-remove-btn" 
                (click)="darDeBaja(activity, participant)"
                [title]="'Dar de baja a ' + participant">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Botón de Inscripción -->
        <button 
          type="button"
          class="btn w-100"
          [class]="getInscriptionButtonClass(activity)"
          [disabled]="isActivityFull(activity) || !permitirInscripciones"
          (click)="inscribirse(activity)">
          
          <i [class]="getInscriptionButtonIcon(activity)"></i>
          {{ getInscriptionButtonText(activity) }}
        </button>

        <!-- Indicador de estado -->
        <div *ngIf="isActivityFull(activity)" class="text-center mt-2">
          <small class="text-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Actividad completa
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mensaje cuando no hay actividades -->
<div *ngIf="!actividades || actividades.length === 0" class="text-center py-5">
  <div class="empty-state">
    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No hay actividades disponibles</h4>
    <p class="text-muted">{{ mensajeVacio || 'Comienza agregando una nueva actividad deportiva.' }}</p>
  </div>
</div>

</section>